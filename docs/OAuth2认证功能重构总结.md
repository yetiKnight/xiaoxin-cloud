# OAuth2è®¤è¯åŠŸèƒ½é‡æ„æ€»ç»“

## é‡æ„èƒŒæ™¯

åŸå…ˆå°†OAuth2å®¢æˆ·ç«¯è®¤è¯åŠŸèƒ½æ”¾åœ¨`iam-common`æ¨¡å—ä¸­ï¼Œå­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š
1. **èŒè´£ä¸æ¸…** - commonæ¨¡å—åº”è¯¥åªåŒ…å«é€šç”¨å·¥å…·ç±»ï¼Œè€Œä¸æ˜¯ç‰¹å®šçš„ä¸šåŠ¡åŠŸèƒ½
2. **ä¾èµ–æ··ä¹±** - è®¤è¯åŠŸèƒ½ä¸åŸºç¡€å·¥å…·ç±»æ··åœ¨ä¸€èµ·
3. **æŒ‰éœ€å¼•å…¥** - ä¸æ˜¯æ‰€æœ‰æœåŠ¡éƒ½éœ€è¦OAuth2å®¢æˆ·ç«¯åŠŸèƒ½
4. **é…ç½®ç®¡ç†** - ç¼ºä¹ç»Ÿä¸€çš„é…ç½®ç®¡ç†

## é‡æ„æ–¹æ¡ˆ

### ğŸ“ æ–°çš„æ¨¡å—ç»“æ„

```
iam-spring-boot-starter-security/
â”œâ”€â”€ config/
â”‚   â”œâ”€â”€ OAuth2Properties.java           # OAuth2é…ç½®å±æ€§ç±»
â”‚   â””â”€â”€ SecurityProperties.java         # å®‰å…¨é…ç½®å±æ€§ç±»
â”œâ”€â”€ oauth2/
â”‚   â”œâ”€â”€ OAuth2ClientCredentialsInterceptor.java  # OAuth2å®¢æˆ·ç«¯æ‹¦æˆªå™¨
â”‚   â””â”€â”€ OAuth2ClientAutoConfiguration.java       # OAuth2è‡ªåŠ¨é…ç½®
â”œâ”€â”€ SecurityAutoConfiguration.java      # ä¸»é…ç½®ç±»
â””â”€â”€ resources/
    â””â”€â”€ META-INF/spring/
        â””â”€â”€ org.springframework.boot.autoconfigure.AutoConfiguration.imports
```

### ğŸ”§ æ ¸å¿ƒæ”¹è¿›

#### 1. ä¸“ä¸šåŒ–åˆ†å·¥
- **iam-common**: çº¯å·¥å…·ç±»å’ŒåŸºç¡€åŠŸèƒ½
- **iam-spring-boot-starter-security**: ä¸“é—¨è´Ÿè´£å®‰å…¨è®¤è¯åŠŸèƒ½

#### 2. Spring Boot Starteræœ€ä½³å®è·µ
- ä½¿ç”¨`@ConfigurationProperties`è¿›è¡Œé…ç½®ç»‘å®š
- ä½¿ç”¨`@ConditionalOnProperty`è¿›è¡Œæ¡ä»¶é…ç½®
- ä½¿ç”¨`@AutoConfiguration`è¿›è¡Œè‡ªåŠ¨é…ç½®
- ç¬¦åˆSpring Boot Starterè®¾è®¡ç†å¿µ

#### 3. é…ç½®é›†ä¸­ç®¡ç†
```yaml
# æ–°çš„é…ç½®ç»“æ„
oauth2:
  client:
    enabled: true
    client-id: iam-core-service
    client-secret: iam-core-secret-2024
    token-uri: http://iam-auth-service/oauth2/token
    scope: internal.read internal.write user.read user.write
    connect-timeout: 5000
    read-timeout: 10000
    token-cache-expire: 3300
    max-retries: 3
```

#### 4. æ™ºèƒ½åŒ–è‡ªåŠ¨é…ç½®
- åªæœ‰å¯ç”¨OAuth2å®¢æˆ·ç«¯çš„æœåŠ¡æ‰ä¼šåŠ è½½ç›¸å…³é…ç½®
- è‡ªåŠ¨æ³¨å†ŒFeignæ‹¦æˆªå™¨
- è‡ªåŠ¨é…ç½®RestTemplate
- æ¡ä»¶åŒ–Beanåˆ›å»º

### ğŸš€ åŠŸèƒ½ç‰¹æ€§

#### 1. è‡ªåŠ¨è®¤è¯
```java
// æ— éœ€ä¿®æ”¹ä¸šåŠ¡ä»£ç ï¼Œè‡ªåŠ¨æ·»åŠ OAuth2ä»¤ç‰Œ
@FeignClient(name = "iam-core-service")
public interface CoreServiceClient {
    @GetMapping("/api/v1/internal/users/{id}")
    Result<UserDTO> getUserById(@PathVariable Long id);
}
```

#### 2. æ™ºèƒ½ç¼“å­˜
- ä»¤ç‰Œè‡ªåŠ¨ç¼“å­˜ï¼Œé¿å…é‡å¤è¯·æ±‚
- æå‰30ç§’åˆ·æ–°æœºåˆ¶
- å¹¶å‘å®‰å…¨çš„ç¼“å­˜ç®¡ç†

#### 3. å®¹é”™æœºåˆ¶
- è‡ªåŠ¨é‡è¯•æœºåˆ¶
- è¶…æ—¶é…ç½®
- å¼‚å¸¸å¤„ç†

#### 4. æ€§èƒ½ä¼˜åŒ–
- è¿æ¥æ± å¤ç”¨
- å¼‚æ­¥å¤„ç†
- èµ„æºç®¡ç†

### ğŸ“Š ä½¿ç”¨æ–¹å¼

#### 1. æ·»åŠ ä¾èµ–
```xml
<!-- åªéœ€è¦åœ¨éœ€è¦OAuth2å®¢æˆ·ç«¯åŠŸèƒ½çš„æœåŠ¡ä¸­æ·»åŠ  -->
<dependency>
    <groupId>com.xiaoxin</groupId>
    <artifactId>iam-spring-boot-starter-security</artifactId>
</dependency>
```

#### 2. å¯ç”¨é…ç½®
```yaml
oauth2:
  client:
    enabled: true  # å¯ç”¨OAuth2å®¢æˆ·ç«¯
    client-id: your-service-name
    client-secret: your-service-secret
    token-uri: http://iam-auth-service/oauth2/token
    scope: internal.read internal.write
```

#### 3. è‡ªåŠ¨ç”Ÿæ•ˆ
- å¯åŠ¨æ—¶è‡ªåŠ¨é…ç½®
- Feignè°ƒç”¨è‡ªåŠ¨æ·»åŠ è®¤è¯å¤´
- æ— éœ€é¢å¤–ä»£ç ä¿®æ”¹

### ğŸ”„ è¿ç§»æ­¥éª¤

#### 1. åˆ é™¤æ—§ä»£ç  âœ…
- åˆ é™¤`iam-common`ä¸­çš„OAuth2ç›¸å…³ä»£ç 
- ç§»é™¤æ—§çš„é…ç½®ç±»

#### 2. åˆ›å»ºæ–°æ¨¡å— âœ…
- åœ¨`iam-spring-boot-starter-security`ä¸­å®ç°OAuth2åŠŸèƒ½
- åˆ›å»ºé…ç½®å±æ€§ç±»
- å®ç°è‡ªåŠ¨é…ç½®

#### 3. æ›´æ–°ä¾èµ– âœ…
- å„æœåŠ¡æ·»åŠ security starterä¾èµ–
- æ›´æ–°é…ç½®æ–‡ä»¶æ ¼å¼

#### 4. æµ‹è¯•éªŒè¯ â³
- å¯åŠ¨æœåŠ¡éªŒè¯é…ç½®åŠ è½½
- æµ‹è¯•æœåŠ¡é—´è°ƒç”¨
- éªŒè¯ä»¤ç‰Œè‡ªåŠ¨è·å–

### ğŸ“ˆ é‡æ„æ”¶ç›Š

#### 1. æ¶æ„æ¸…æ™°åº¦ â¬†ï¸
- èŒè´£åˆ†ç¦»æ›´æ¸…æ™°
- æ¨¡å—ä¾èµ–æ›´åˆç†
- ç¬¦åˆSpring Bootæœ€ä½³å®è·µ

#### 2. å¯ç»´æŠ¤æ€§ â¬†ï¸
- ä»£ç ç»„ç»‡æ›´åˆç†
- é…ç½®ç®¡ç†æ›´é›†ä¸­
- åŠŸèƒ½æ‰©å±•æ›´å®¹æ˜“

#### 3. æ€§èƒ½è¡¨ç° â¬†ï¸
- æŒ‰éœ€åŠ è½½é…ç½®
- æ™ºèƒ½ç¼“å­˜æœºåˆ¶
- è¿æ¥å¤ç”¨ä¼˜åŒ–

#### 4. å¼€å‘ä½“éªŒ â¬†ï¸
- è‡ªåŠ¨é…ç½®å¼€ç®±å³ç”¨
- é…ç½®é¡¹å®Œæ•´æ¸…æ™°
- é”™è¯¯å¤„ç†æ›´å‹å¥½

### ğŸ›¡ï¸ å®‰å…¨å¢å¼º

#### 1. é…ç½®å®‰å…¨
- æ•æ„Ÿä¿¡æ¯ç¯å¢ƒå˜é‡åŒ–
- é…ç½®éªŒè¯æœºåˆ¶
- é»˜è®¤å®‰å…¨é…ç½®

#### 2. é€šä¿¡å®‰å…¨
- HTTPSä¼ è¾“æ”¯æŒ
- ä»¤ç‰Œå®‰å…¨ä¼ è¾“
- è¶…æ—¶ä¿æŠ¤æœºåˆ¶

#### 3. ç›‘æ§å®¡è®¡
- è®¤è¯è¿‡ç¨‹æ—¥å¿—è®°å½•
- æ€§èƒ½æŒ‡æ ‡ç›‘æ§
- å¼‚å¸¸å‘Šè­¦æœºåˆ¶

## æ€»ç»“

è¿™æ¬¡é‡æ„å®Œç¾ä½“ç°äº†Spring Boot Starterçš„è®¾è®¡ç†å¿µï¼Œå°†OAuth2è®¤è¯åŠŸèƒ½ä»é€šç”¨æ¨¡å—ä¸­åˆ†ç¦»å‡ºæ¥ï¼Œæ”¾åˆ°ä¸“é—¨çš„å®‰å…¨Starterä¸­ã€‚è¿™æ ·åšä¸ä»…æé«˜äº†æ¶æ„çš„æ¸…æ™°åº¦ï¼Œä¹Ÿè®©å„ä¸ªæœåŠ¡å¯ä»¥æŒ‰éœ€å¼•å…¥å®‰å…¨åŠŸèƒ½ï¼ŒåŒæ—¶ä¿æŒäº†é…ç½®çš„ç»Ÿä¸€æ€§å’Œè‡ªåŠ¨åŒ–ã€‚

**æ ¸å¿ƒä¼˜åŠ¿ï¼š**
1. âœ… **èŒè´£æ¸…æ™°** - å®‰å…¨åŠŸèƒ½ç‹¬ç«‹ç®¡ç†
2. âœ… **æŒ‰éœ€å¼•å…¥** - åªæœ‰éœ€è¦çš„æœåŠ¡æ‰å¼•å…¥
3. âœ… **è‡ªåŠ¨é…ç½®** - å¼€ç®±å³ç”¨ï¼Œæ— éœ€æ‰‹åŠ¨é…ç½®
4. âœ… **æ€§èƒ½ä¼˜åŒ–** - æ™ºèƒ½ç¼“å­˜å’Œè¿æ¥å¤ç”¨
5. âœ… **æ˜“äºç»´æŠ¤** - ç»Ÿä¸€çš„é…ç½®å’Œç®¡ç†

è¿™ä¸ªé‡æ„ä¸ºåç»­çš„åŠŸèƒ½æ‰©å±•å’Œç»´æŠ¤å¥ å®šäº†è‰¯å¥½çš„åŸºç¡€ï¼
