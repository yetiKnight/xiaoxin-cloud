# IAM网关监控配置说明

## 监控架构概述

IAM网关采用基于Spring Boot Actuator + Micrometer + Prometheus的监控体系，提供全面的应用监控、性能监控和业务监控能力。

## 监控组件

### 1. Spring Boot Actuator
- **健康检查**: `/actuator/health`
- **应用信息**: `/actuator/info`
- **监控指标**: `/actuator/metrics`
- **Prometheus指标**: `/actuator/prometheus`
- **网关信息**: `/actuator/gateway`

### 2. Micrometer监控指标
- **JVM指标**: 内存、GC、线程等
- **HTTP指标**: 请求量、响应时间、错误率
- **网关指标**: 路由统计、限流统计、熔断统计
- **自定义指标**: 认证统计、业务指标

### 3. 健康检查指标
- **网关健康**: 路由配置、内存使用、线程状态
- **Sentinel健康**: 限流规则、熔断状态、阻塞率
- **Nacos健康**: 服务发现、实例状态、健康率

## 监控端点配置

### 端点暴露配置
```yaml
management:
  endpoints:
    web:
      exposure:
        include: "*"  # 暴露所有端点
      base-path: /actuator
    jmx:
      exposure:
        include: "*"
```

### 端点安全配置
- **公开端点**: health, info, prometheus
- **管理员端点**: metrics, gateway, beans, env等
- **认证方式**: JWT Token认证
- **权限要求**: ROLE_ADMIN

## 监控指标详解

### 1. 系统指标

#### JVM指标
```
# 内存使用
jvm_memory_used_bytes
jvm_memory_max_bytes
jvm_memory_committed_bytes

# GC指标
jvm_gc_pause_seconds
jvm_gc_memory_allocated_bytes_total
jvm_gc_memory_promoted_bytes_total

# 线程指标
jvm_threads_live_threads
jvm_threads_daemon_threads
jvm_threads_peak_threads
```

#### 系统指标
```
# CPU使用率
system_cpu_usage
process_cpu_usage

# 磁盘空间
disk_free_bytes
disk_total_bytes
```

### 2. HTTP指标

#### 请求指标
```
# 请求总数
http_server_requests_seconds_count

# 请求时间
http_server_requests_seconds_sum
http_server_requests_seconds_max

# 请求时间分布
http_server_requests_seconds_bucket
```

#### 响应状态
```
# 按状态码分类
http_server_requests_seconds_count{status="200"}
http_server_requests_seconds_count{status="404"}
http_server_requests_seconds_count{status="500"}
```

### 3. 网关指标

#### 路由指标
```
# 路由数量
gateway_routes_count

# 路由请求
spring_cloud_gateway_requests_seconds_count
spring_cloud_gateway_requests_seconds_sum
spring_cloud_gateway_requests_seconds_max
```

#### 自定义网关指标
```
# 认证指标
gateway_auth_success_total
gateway_auth_failure_total

# 限流指标
gateway_rate_limit_triggered_total

# 熔断指标
gateway_sentinel_blocked_total

# 请求处理时间
gateway_request_duration_seconds

# 活跃连接数
gateway_connections_active

# 内存使用百分比
gateway_jvm_memory_used_percent
```

### 4. 业务指标

#### Sentinel指标
```
# 规则数量
sentinel_rules_count

# 请求统计
sentinel_requests_total
sentinel_requests_blocked
sentinel_requests_success
sentinel_requests_exception

# 阻塞率
sentinel_block_rate_percent

# 异常率
sentinel_exception_rate_percent
```

#### Nacos指标
```
# 服务实例
nacos_instances_total
nacos_instances_healthy

# 健康率
nacos_healthy_rate_percent

# 服务状态
nacos_service_status{service="iam-auth-service"}
nacos_service_status{service="iam-core-service"}
```

## 健康检查详解

### 1. 网关健康检查
- **检查项目**: 路由配置、内存使用、线程状态
- **健康标准**: 
  - 路由数量 > 0
  - 内存使用率 < 90%
  - 活跃线程数 < 500
- **状态级别**: UP, DOWN, UNKNOWN

### 2. Sentinel健康检查
- **检查项目**: 限流规则、阻塞率、异常率
- **健康标准**:
  - 阻塞率 < 20%
  - 异常率 < 5%
- **告警阈值**:
  - 阻塞率 > 50% → DOWN
  - 异常率 > 10% → DOWN

### 3. Nacos健康检查
- **检查项目**: 服务发现、实例状态
- **健康标准**:
  - 服务实例数量 > 0
  - 健康实例率 > 80%
- **告警阈值**:
  - 健康率 < 50% → DOWN
  - 无实例 → DOWN

## Prometheus集成

### 1. 指标暴露
```
# Prometheus指标端点
GET /actuator/prometheus

# 指标格式
# HELP gateway_auth_success_total Number of successful authentications
# TYPE gateway_auth_success_total counter
gateway_auth_success_total{application="iam-gateway",service="gateway",version="1.0.0"} 123.0
```

### 2. 指标标签
- **通用标签**: application, service, version, environment
- **HTTP标签**: method, uri, status, exception
- **网关标签**: route, routeId, routeUri

### 3. 指标过滤
```yaml
# 过滤不需要的指标
meterFilter:
  deny:
    - "jvm.classes.*"
    - "jvm.compilation.*"
    - "process.files.*"
    - "system.load.*"
```

## 监控告警配置

### 1. 告警规则示例

#### 系统告警
```yaml
# 内存使用率告警
- alert: HighMemoryUsage
  expr: gateway_jvm_memory_used_percent > 85
  for: 2m
  labels:
    severity: warning
  annotations:
    summary: "网关内存使用率过高"
    description: "网关内存使用率为 {{ $value }}%"

# CPU使用率告警
- alert: HighCpuUsage
  expr: system_cpu_usage > 0.8
  for: 5m
  labels:
    severity: warning
  annotations:
    summary: "网关CPU使用率过高"
```

#### 业务告警
```yaml
# 认证失败率告警
- alert: HighAuthFailureRate
  expr: rate(gateway_auth_failure_total[5m]) / rate(gateway_auth_success_total[5m]) > 0.1
  for: 2m
  labels:
    severity: critical
  annotations:
    summary: "认证失败率过高"

# 限流触发告警
- alert: RateLimitTriggered
  expr: increase(gateway_rate_limit_triggered_total[1m]) > 10
  for: 1m
  labels:
    severity: warning
  annotations:
    summary: "限流频繁触发"
```

#### 健康检查告警
```yaml
# 健康检查失败
- alert: HealthCheckFailed
  expr: up{job="iam-gateway"} == 0
  for: 1m
  labels:
    severity: critical
  annotations:
    summary: "网关健康检查失败"

# 服务实例不健康
- alert: UnhealthyServiceInstances
  expr: nacos_healthy_rate_percent < 80
  for: 3m
  labels:
    severity: warning
  annotations:
    summary: "服务实例健康率低于80%"
```

## 监控仪表板

### 1. Grafana仪表板模板
```json
{
  "dashboard": {
    "title": "IAM网关监控",
    "panels": [
      {
        "title": "请求量",
        "type": "graph",
        "targets": [
          {
            "expr": "rate(http_server_requests_seconds_count[1m])",
            "legendFormat": "{{method}} {{uri}}"
          }
        ]
      },
      {
        "title": "响应时间",
        "type": "graph", 
        "targets": [
          {
            "expr": "histogram_quantile(0.95, rate(http_server_requests_seconds_bucket[1m]))",
            "legendFormat": "95th percentile"
          }
        ]
      }
    ]
  }
}
```

### 2. 关键监控指标
- **请求量**: QPS、TPS
- **响应时间**: P50, P95, P99
- **错误率**: 4xx, 5xx错误率
- **系统资源**: CPU、内存、磁盘
- **业务指标**: 认证成功率、限流触发率

## 性能优化建议

### 1. 监控性能优化
- **指标缓存**: 健康检查结果缓存10秒
- **指标过滤**: 过滤不必要的JVM指标
- **采样率控制**: 链路跟踪采样率10%
- **批量导出**: Prometheus指标30秒导出一次

### 2. 存储优化
- **指标保留**: 短期指标保留7天，长期指标保留30天
- **数据压缩**: 启用Prometheus数据压缩
- **分片存储**: 按时间和标签分片存储

### 3. 查询优化
- **索引优化**: 为常用查询创建索引
- **查询缓存**: 缓存常用查询结果
- **分页查询**: 大数据量查询使用分页

## 故障排查指南

### 1. 常见问题

#### 监控端点无法访问
- 检查Actuator配置
- 检查端点安全配置
- 检查网络连通性

#### 指标数据异常
- 检查MeterRegistry配置
- 检查指标过滤规则
- 检查Prometheus配置

#### 健康检查失败
- 查看健康检查详细信息
- 检查依赖服务状态
- 检查系统资源使用情况

### 2. 日志分析
```bash
# 查看监控相关日志
kubectl logs -f deployment/iam-gateway | grep -E "(actuator|metrics|health)"

# 查看Prometheus指标
curl http://localhost:8080/actuator/prometheus | grep gateway

# 查看健康检查详情
curl http://localhost:8080/actuator/health | jq .
```

## 最佳实践

### 1. 监控策略
- **分层监控**: 基础设施、应用、业务三层监控
- **主动监控**: 定期健康检查和指标采集
- **告警分级**: 按严重程度分级告警
- **故障自愈**: 自动重启、熔断恢复

### 2. 指标设计
- **指标命名**: 使用统一的命名规范
- **标签使用**: 合理使用标签进行分类
- **指标聚合**: 避免高基数指标
- **性能考虑**: 平衡监控精度和性能开销

### 3. 运维建议
- **监控覆盖**: 确保关键路径100%监控覆盖
- **告警降噪**: 避免告警风暴
- **文档维护**: 及时更新监控文档
- **团队培训**: 定期进行监控培训

通过完善的监控配置，IAM网关能够提供全面的可观测性，帮助运维团队及时发现和解决问题，确保系统稳定运行。
